name: Release

on:
  release:
    types: [published]

jobs:
  release:
    name: Build, Sign, and Publish
    runs-on: ubuntu-latest
    environment: npm-publish
    permissions:
      contents: write
      id-token: write
    
    steps:
    # ============================================
    # 1. SETUP
    # ============================================
    - name: Checkout tagged code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # ============================================
    # 2. VALIDATE (Test tagged code)
    # ============================================
    - name: Run full test suite
      run: npm test
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Run linter
      run: npm run lint
    
    - name: Run type check
      run: npm run typecheck
    
    - name: Dependency audit (high/critical)
      run: npm audit --audit-level=high --production
    
    # ============================================
    # 3. BUILD (Generate all artifacts)
    # ============================================
    - name: Build main library
      run: npm run build
    
    - name: Build browser bundle
      run: npm run build:browser
    
    - name: Build validator
      run: npm run build:validator
    
    - name: Verify validator version matches
      run: cd validator && npm run verify
    
    # ============================================
    # 4. SECURITY - Import GPG Key
    # ============================================
    - name: Import GPG key
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --quick-set-expire $(gpg --list-secret-keys --with-colons | grep fpr | head -1 | cut -d: -f10) 0
        
        # Verify key imported successfully
        gpg --list-secret-keys
        echo "‚úì GPG key imported and configured"
    
    # ============================================
    # 5. CHECKSUMS - Generate for all artifacts
    # ============================================
    - name: Generate checksums (main library)
      run: |
        cd dist
        
        echo "# SHA256 Checksums - @grifortis/schiavinato-sharing" > ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "Version: ${{ github.event.release.tag_name }}" >> ../CHECKSUMS-LIBRARY.txt
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        
        echo "## Main Package Files" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        sha256sum index.js index.mjs index.d.ts index.d.mts >> ../CHECKSUMS-LIBRARY.txt
        
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "## Browser Bundle" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        cd browser
        sha256sum index.global.js >> ../../CHECKSUMS-LIBRARY.txt
        
        echo "" >> ../../CHECKSUMS-LIBRARY.txt
        echo "## Verification" >> ../../CHECKSUMS-LIBRARY.txt
        echo "" >> ../../CHECKSUMS-LIBRARY.txt
        echo "To verify files, run:" >> ../../CHECKSUMS-LIBRARY.txt
        echo "  sha256sum -c CHECKSUMS-LIBRARY.txt" >> ../../CHECKSUMS-LIBRARY.txt
        
        cd ../..
        echo "=== Library Checksums Generated ==="
        cat CHECKSUMS-LIBRARY.txt
    
    - name: Generate checksums (validator)
      run: |
        cd validator/dist
        
        echo "# SHA256 Checksums - @grifortis/schiavinato-validator" > ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "Version: ${{ github.event.release.tag_name }}" >> ../CHECKSUMS-VALIDATOR.txt
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "## Validator HTML" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        
        sha256sum schiavinato-validator-${{ github.event.release.tag_name }}.html >> ../CHECKSUMS-VALIDATOR.txt
        
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "## Verification" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "To verify files, run:" >> ../CHECKSUMS-VALIDATOR.txt
        echo "  sha256sum -c CHECKSUMS-VALIDATOR.txt" >> ../CHECKSUMS-VALIDATOR.txt
        
        cd ..
        echo "=== Validator Checksums Generated ==="
        cat CHECKSUMS-VALIDATOR.txt
    
    # ============================================
    # 6. GPG SIGNATURES - Sign all artifacts
    # ============================================
    - name: Sign library checksums
      run: |
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-LIBRARY.txt
        
        gpg --verify CHECKSUMS-LIBRARY.txt.asc CHECKSUMS-LIBRARY.txt
        echo "‚úì Library checksums signed and verified"
    
    - name: Sign validator artifacts
      run: |
        cd validator/dist
        
        # Sign HTML
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${{ github.event.release.tag_name }}.html
        
        # Sign checksum
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${{ github.event.release.tag_name }}.html.sha256
        
        # Verify signatures
        gpg --verify schiavinato-validator-${{ github.event.release.tag_name }}.html.asc \
                     schiavinato-validator-${{ github.event.release.tag_name }}.html
        gpg --verify schiavinato-validator-${{ github.event.release.tag_name }}.html.sha256.asc \
                     schiavinato-validator-${{ github.event.release.tag_name }}.html.sha256
        
        echo "‚úì Validator artifacts signed and verified"
    
    - name: Sign validator checksums
      run: |
        cd validator
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-VALIDATOR.txt
        
        gpg --verify CHECKSUMS-VALIDATOR.txt.asc CHECKSUMS-VALIDATOR.txt
        echo "‚úì Validator checksums signed and verified"
    
    # ============================================
    # 7. CREATE RELEASE TARBALL
    # ============================================
    - name: Create release tarball
      run: |
        tar -czf schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz \
          dist/ \
          CHECKSUMS-LIBRARY.txt \
          CHECKSUMS-LIBRARY.txt.asc \
          README.md \
          LICENSE \
          CHANGELOG.md \
          package.json
        
        sha256sum schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz > \
                  schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz.sha256
        
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz
        
        gpg --verify schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz.asc \
                     schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz
        
        echo "‚úì Release tarball created, checksummed, and signed"
        ls -lh schiavinato-sharing-*.tar.gz*
    
    # ============================================
    # 8. PUBLISH TO NPM (Immutable, with provenance)
    # ============================================
    - name: Publish main library to NPM
      run: npm publish --provenance --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Publish validator to NPM
      run: cd validator && npm publish --provenance --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    # ============================================
    # 9. UPLOAD ARTIFACTS TO GITHUB RELEASE
    # ============================================
    - name: Upload signed artifacts to release
      uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
      with:
        files: |
          CHECKSUMS-LIBRARY.txt
          CHECKSUMS-LIBRARY.txt.asc
          schiavinato-sharing-*.tar.gz
          schiavinato-sharing-*.tar.gz.sha256
          schiavinato-sharing-*.tar.gz.asc
          validator/CHECKSUMS-VALIDATOR.txt
          validator/CHECKSUMS-VALIDATOR.txt.asc
          validator/dist/schiavinato-validator-*.html
          validator/dist/schiavinato-validator-*.html.sha256
          validator/dist/schiavinato-validator-*.html.asc
          validator/dist/schiavinato-validator-*.html.sha256.asc
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ============================================
    # 10. UPDATE RELEASE NOTES WITH VERIFICATION
    # ============================================
    - name: Update release with verification instructions
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        script: |
          const fs = require('fs');
          const libraryChecksums = fs.readFileSync('CHECKSUMS-LIBRARY.txt', 'utf8');
          const validatorChecksums = fs.readFileSync('validator/CHECKSUMS-VALIDATOR.txt', 'utf8');
          
          const verificationInfo = `

## üîê Security Verification

### Package Integrity

**Main Library:** \`@grifortis/schiavinato-sharing@${{ github.event.release.tag_name }}\`  
**Validator:** \`@grifortis/schiavinato-validator@${{ github.event.release.tag_name }}\`

### SHA256 Checksums

<details>
<summary><strong>Main Library Checksums</strong></summary>

\`\`\`
${libraryChecksums}
\`\`\`
</details>

<details>
<summary><strong>Validator Checksums</strong></summary>

\`\`\`
${validatorChecksums}
\`\`\`
</details>

### GPG Verification

All release artifacts are signed with GRIFORTIS GPG key.

**Import public key:**
\`\`\`bash
curl -fsSL https://raw.githubusercontent.com/GRIFORTIS/schiavinato-sharing-js/main/GRIFORTIS-PGP-PUBLIC-KEY.asc | gpg --import
\`\`\`

**Verify signatures:**
\`\`\`bash
# Verify library checksums
gpg --verify CHECKSUMS-LIBRARY.txt.asc CHECKSUMS-LIBRARY.txt

# Verify tarball
gpg --verify schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz.asc \\
             schiavinato-sharing-${{ github.event.release.tag_name }}.tar.gz

# Verify validator HTML
gpg --verify validator/dist/schiavinato-validator-${{ github.event.release.tag_name }}.html.asc \\
             validator/dist/schiavinato-validator-${{ github.event.release.tag_name }}.html

# Verify validator checksums
gpg --verify validator/CHECKSUMS-VALIDATOR.txt.asc validator/CHECKSUMS-VALIDATOR.txt
\`\`\`

**Expected key fingerprint:** \`4CFE 6248 C57F 15DF\`

### NPM Provenance

Both packages published with [npm provenance](https://docs.npmjs.com/generating-provenance-statements) for build transparency.

**Verify packages:**
\`\`\`bash
npm view @grifortis/schiavinato-sharing@${{ github.event.release.tag_name }}
npm view @grifortis/schiavinato-validator@${{ github.event.release.tag_name }}
\`\`\`

---

**‚ö†Ô∏è SECURITY:** Always verify signatures before using in production. See [SECURITY.md](https://github.com/GRIFORTIS/schiavinato-sharing-js/blob/main/SECURITY.md) for complete verification procedures.
`;
          
          const currentBody = context.payload.release.body || '';
          
          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id,
            body: currentBody + verificationInfo
          });
          
          console.log('‚úì Release notes updated with verification information');
