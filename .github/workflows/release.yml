name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Why are you running a dry-run? (for audit trail)'
        required: true
        type: string

jobs:
  dry-run:
    name: Dry-run (no publish)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    # ============================================
    # 1. SETUP
    # ============================================
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci

    - name: Resolve version metadata
      id: meta
      shell: bash
      run: |
        set -euo pipefail
        PKG_VERSION="$(node -p "require('./package.json').version")"
        TAG_NORM="v${PKG_VERSION}"
        echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"
        echo "tag_norm=$TAG_NORM" >> "$GITHUB_OUTPUT"
    
    # ============================================
    # 2. VALIDATE (Test tagged code)
    # ============================================
    - name: Run full test suite
      run: npm test
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Run linter
      run: npm run lint
    
    - name: Run type check
      run: npm run typecheck
    
    - name: Dependency audit (high/critical)
      run: npm audit --audit-level=high --omit=dev
    
    # ============================================
    # 3. BUILD (Generate all artifacts)
    # ============================================
    - name: Build main library
      run: npm run build
    
    - name: Build browser bundle
      run: npm run build:browser
    
    - name: Build validator
      run: npm run build:validator
    
    - name: Verify validator version matches
      run: cd validator && npm run verify
    
    # ============================================
    # 4. SECURITY - Import GPG Key
    # ============================================
    - name: Import GPG key
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        gpg --list-secret-keys --keyid-format LONG
    
    # ============================================
    # 5. CHECKSUMS - Generate for all artifacts
    # ============================================
    - name: Generate checksums (main library)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd dist
        
        echo "# SHA256 Checksums - @grifortis/schiavinato-sharing" > ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "Version: ${TAG}" >> ../CHECKSUMS-LIBRARY.txt
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        
        echo "## Main Package Files" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        sha256sum index.js index.mjs index.d.ts index.d.mts >> ../CHECKSUMS-LIBRARY.txt
        
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "## Browser Bundle" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        cd browser
        sha256sum index.global.js >> ../../CHECKSUMS-LIBRARY.txt
        
        echo "" >> ../../CHECKSUMS-LIBRARY.txt
        echo "## Verification" >> ../../CHECKSUMS-LIBRARY.txt
        echo "" >> ../../CHECKSUMS-LIBRARY.txt
        echo "To verify files, run:" >> ../../CHECKSUMS-LIBRARY.txt
        echo "  sha256sum -c CHECKSUMS-LIBRARY.txt" >> ../../CHECKSUMS-LIBRARY.txt
        
        cd ../..
        echo "=== Library Checksums Generated ==="
        cat CHECKSUMS-LIBRARY.txt
    
    - name: Generate checksums (validator)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        
        echo "# SHA256 Checksums - @grifortis/schiavinato-validator" > ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "Version: ${TAG}" >> ../CHECKSUMS-VALIDATOR.txt
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "## Validator HTML" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        
        sha256sum schiavinato-validator-${TAG}.html >> ../CHECKSUMS-VALIDATOR.txt
        
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "## Verification" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "To verify files, run:" >> ../CHECKSUMS-VALIDATOR.txt
        echo "  sha256sum -c CHECKSUMS-VALIDATOR.txt" >> ../CHECKSUMS-VALIDATOR.txt
        
        cd ..
        echo "=== Validator Checksums Generated ==="
        cat CHECKSUMS-VALIDATOR.txt
    
    # ============================================
    # 6. GPG SIGNATURES - Sign all artifacts
    # ============================================
    - name: Sign library checksums
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-LIBRARY.txt
        
        gpg --verify CHECKSUMS-LIBRARY.txt.asc CHECKSUMS-LIBRARY.txt
        echo "✓ Library checksums signed and verified"
    
    - name: Sign validator artifacts
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        
        # Sign HTML
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html
        
        # Sign checksum
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html.sha256
        
        # Verify signatures
        gpg --verify schiavinato-validator-${TAG}.html.asc \
                     schiavinato-validator-${TAG}.html
        gpg --verify schiavinato-validator-${TAG}.html.sha256.asc \
                     schiavinato-validator-${TAG}.html.sha256
        
        echo "✓ Validator artifacts signed and verified"
    
    - name: Sign validator checksums
      run: |
        set -euo pipefail
        cd validator
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-VALIDATOR.txt
        
        gpg --verify CHECKSUMS-VALIDATOR.txt.asc CHECKSUMS-VALIDATOR.txt
        echo "✓ Validator checksums signed and verified"
    
    # ============================================
    # 7. CREATE RELEASE TARBALL
    # ============================================
    - name: Create release tarball
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        tar -czf schiavinato-sharing-${TAG}.tar.gz \
          dist/ \
          CHECKSUMS-LIBRARY.txt \
          CHECKSUMS-LIBRARY.txt.asc \
          README.md \
          LICENSE \
          CHANGELOG.md \
          package.json
        
        sha256sum schiavinato-sharing-${TAG}.tar.gz > \
                  schiavinato-sharing-${TAG}.tar.gz.sha256
        
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-sharing-${TAG}.tar.gz
        
        gpg --verify schiavinato-sharing-${TAG}.tar.gz.asc \
                     schiavinato-sharing-${TAG}.tar.gz
        
        echo "✓ Release tarball created, checksummed, and signed"
        ls -lh schiavinato-sharing-*.tar.gz*
    
    # ============================================
    # 8. UPLOAD ARTIFACTS (dry-run)
    # ============================================
    - name: Upload artifacts (dry-run)
      uses: actions/upload-artifact@4c0ff1c489dca52fedb26375d7d8fe7bd9233f19 # v4.4.0
      with:
        name: release-dry-run-${{ steps.meta.outputs.tag_norm }}
        path: |
          CHECKSUMS-LIBRARY.txt
          CHECKSUMS-LIBRARY.txt.asc
          schiavinato-sharing-*.tar.gz
          schiavinato-sharing-*.tar.gz.sha256
          schiavinato-sharing-*.tar.gz.asc
          validator/CHECKSUMS-VALIDATOR.txt
          validator/CHECKSUMS-VALIDATOR.txt.asc
          validator/dist/schiavinato-validator-*.html
          validator/dist/schiavinato-validator-*.html.sha256
          validator/dist/schiavinato-validator-*.html.asc
          validator/dist/schiavinato-validator-*.html.sha256.asc
        retention-days: 14

  release:
    name: Release (publish library + upload assets)
    runs-on: ubuntu-latest
    environment: npm-publish
    permissions:
      contents: write
      id-token: write
    if: github.event_name == 'release'

    steps:
    - name: Checkout tagged code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Resolve version metadata (and verify tag matches)
      id: meta
      shell: bash
      run: |
        set -euo pipefail
        PKG_VERSION="$(node -p "require('./package.json').version")"
        TAG_FROM_EVENT="${{ github.event.release.tag_name }}"
        TAG_NORM="v${PKG_VERSION}"
        echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"
        echo "tag_norm=$TAG_NORM" >> "$GITHUB_OUTPUT"
        if [ "$TAG_FROM_EVENT" != "$TAG_NORM" ] && [ "$TAG_FROM_EVENT" != "$PKG_VERSION" ]; then
          echo "Tag/version mismatch: tag=$TAG_FROM_EVENT pkg=$PKG_VERSION (expected $TAG_NORM)" >&2
          exit 1
        fi

    - name: Run full test suite
      run: npm test

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Run linter
      run: npm run lint

    - name: Run type check
      run: npm run typecheck

    - name: Dependency audit (high/critical)
      run: npm audit --audit-level=high --omit=dev

    - name: Build main library
      run: npm run build

    - name: Build browser bundle
      run: npm run build:browser

    - name: Build validator
      run: npm run build:validator

    - name: Verify validator version matches
      run: cd validator && npm run verify

    - name: Import GPG key
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        gpg --list-secret-keys --keyid-format LONG

    - name: Generate checksums (main library)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd dist
        echo "# SHA256 Checksums - @grifortis/schiavinato-sharing" > ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "Version: ${TAG}" >> ../CHECKSUMS-LIBRARY.txt
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "## Main Package Files" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        sha256sum index.js index.mjs index.d.ts index.d.mts >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        echo "## Browser Bundle" >> ../CHECKSUMS-LIBRARY.txt
        echo "" >> ../CHECKSUMS-LIBRARY.txt
        cd browser
        sha256sum index.global.js >> ../../CHECKSUMS-LIBRARY.txt
        cd ../..

    - name: Generate checksums (validator)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        echo "# SHA256 Checksums - @grifortis/schiavinato-validator" > ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "Version: ${TAG}" >> ../CHECKSUMS-VALIDATOR.txt
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        echo "## Validator HTML" >> ../CHECKSUMS-VALIDATOR.txt
        echo "" >> ../CHECKSUMS-VALIDATOR.txt
        sha256sum schiavinato-validator-${TAG}.html >> ../CHECKSUMS-VALIDATOR.txt
        cd ../..

    - name: Sign library checksums
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-LIBRARY.txt
        gpg --verify CHECKSUMS-LIBRARY.txt.asc CHECKSUMS-LIBRARY.txt

    - name: Sign validator artifacts
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html.sha256
        gpg --verify schiavinato-validator-${TAG}.html.asc schiavinato-validator-${TAG}.html
        gpg --verify schiavinato-validator-${TAG}.html.sha256.asc schiavinato-validator-${TAG}.html.sha256
        cd ../..

    - name: Sign validator checksums
      run: |
        set -euo pipefail
        cd validator
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-VALIDATOR.txt
        gpg --verify CHECKSUMS-VALIDATOR.txt.asc CHECKSUMS-VALIDATOR.txt
        cd ..

    - name: Create release tarball
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        tar -czf schiavinato-sharing-${TAG}.tar.gz \
          dist/ \
          CHECKSUMS-LIBRARY.txt \
          CHECKSUMS-LIBRARY.txt.asc \
          README.md \
          LICENSE \
          CHANGELOG.md \
          package.json
        sha256sum schiavinato-sharing-${TAG}.tar.gz > schiavinato-sharing-${TAG}.tar.gz.sha256
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-sharing-${TAG}.tar.gz
        gpg --verify schiavinato-sharing-${TAG}.tar.gz.asc schiavinato-sharing-${TAG}.tar.gz

    - name: Publish main library to NPM
      run: npm publish --provenance --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Upload signed artifacts to release
      uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
      with:
        files: |
          CHECKSUMS-LIBRARY.txt
          CHECKSUMS-LIBRARY.txt.asc
          schiavinato-sharing-*.tar.gz
          schiavinato-sharing-*.tar.gz.sha256
          schiavinato-sharing-*.tar.gz.asc
          validator/CHECKSUMS-VALIDATOR.txt
          validator/CHECKSUMS-VALIDATOR.txt.asc
          validator/dist/schiavinato-validator-*.html
          validator/dist/schiavinato-validator-*.html.sha256
          validator/dist/schiavinato-validator-*.html.asc
          validator/dist/schiavinato-validator-*.html.sha256.asc
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
