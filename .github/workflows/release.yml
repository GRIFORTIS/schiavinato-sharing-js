name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Why are you running a dry-run? (for audit trail)'
        required: true
        type: string

jobs:
  dry-run:
    name: Dry-run (no publish)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    # ============================================
    # 1. SETUP
    # ============================================
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
      with:
        node-version: '24.x'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci

    - name: Resolve version metadata
      id: meta
      shell: bash
      run: |
        set -euo pipefail
        PKG_VERSION="$(node -p "require('./package.json').version")"
        TAG_NORM="v${PKG_VERSION}"
        echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"
        echo "tag_norm=$TAG_NORM" >> "$GITHUB_OUTPUT"
    
    # ============================================
    # 2. VALIDATE (Test tagged code)
    # ============================================
    - name: Run full test suite
      run: npm test
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Run linter
      run: npm run lint
    
    - name: Run type check
      run: npm run typecheck
    
    - name: Dependency audit (high/critical)
      run: npm audit --audit-level=high --omit=dev
    
    # ============================================
    # 3. BUILD (Generate all artifacts)
    # ============================================
    - name: Build main library
      run: npm run build
    
    - name: Build browser bundle
      run: npm run build:browser
    
    - name: Build validator
      run: npm run build:validator
    
    - name: Verify validator version matches
      run: cd validator && npm run verify
    
    # ============================================
    # 4. SECURITY - Import GPG Key
    # ============================================
    - name: Import GPG key
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        gpg --list-secret-keys --keyid-format LONG
    
    # ============================================
    # 5. CHECKSUMS - Generate for all artifacts
    # ============================================
    - name: Generate checksums (main library)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd dist
        
        {
          echo "# SHA256 Checksums - @grifortis/schiavinato-sharing"
          echo ""
          echo "Version: ${TAG}"
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "## Main Package Files"
          echo ""
          sha256sum index.js index.mjs index.d.ts index.d.mts
          echo ""
          echo "## Browser Bundle"
          echo ""
        } > ../CHECKSUMS-LIBRARY.txt
        
        cd browser
        sha256sum index.global.js >> ../../CHECKSUMS-LIBRARY.txt
        
        {
          echo ""
          echo "## Verification"
          echo ""
          echo "To verify files, run:"
          echo "  sha256sum -c CHECKSUMS-LIBRARY.txt"
        } >> ../../CHECKSUMS-LIBRARY.txt
        
        cd ../..
        echo "=== Library Checksums Generated ==="
        cat CHECKSUMS-LIBRARY.txt
    
    - name: Generate checksums (validator)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        
        {
          echo "# SHA256 Checksums - @grifortis/schiavinato-validator"
          echo ""
          echo "Version: ${TAG}"
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "## Validator HTML"
          echo ""
          sha256sum schiavinato-validator-${TAG}.html
          echo ""
          echo "## Verification"
          echo ""
          echo "To verify files, run:"
          echo "  sha256sum -c CHECKSUMS-VALIDATOR.txt"
        } > ../CHECKSUMS-VALIDATOR.txt
        
        cd ..
        echo "=== Validator Checksums Generated ==="
        cat CHECKSUMS-VALIDATOR.txt
    
    # ============================================
    # 6. GPG SIGNATURES - Sign all artifacts
    # ============================================
    - name: Sign library checksums
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-LIBRARY.txt
        
        gpg --verify CHECKSUMS-LIBRARY.txt.asc CHECKSUMS-LIBRARY.txt
        echo "✓ Library checksums signed and verified"
    
    - name: Sign validator artifacts
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        
        # Sign HTML
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html
        
        # Sign checksum
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html.sha256
        
        # Verify signatures
        gpg --verify schiavinato-validator-${TAG}.html.asc \
                     schiavinato-validator-${TAG}.html
        gpg --verify schiavinato-validator-${TAG}.html.sha256.asc \
                     schiavinato-validator-${TAG}.html.sha256
        
        echo "✓ Validator artifacts signed and verified"
    
    - name: Sign validator checksums
      run: |
        set -euo pipefail
        cd validator
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-VALIDATOR.txt
        
        gpg --verify CHECKSUMS-VALIDATOR.txt.asc CHECKSUMS-VALIDATOR.txt
        echo "✓ Validator checksums signed and verified"
    
    # ============================================
    # 7. CREATE RELEASE TARBALL
    # ============================================
    - name: Create release tarball
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        tar -czf schiavinato-sharing-${TAG}.tar.gz \
          dist/ \
          CHECKSUMS-LIBRARY.txt \
          CHECKSUMS-LIBRARY.txt.asc \
          README.md \
          LICENSE \
          CHANGELOG.md \
          package.json
        
        sha256sum schiavinato-sharing-${TAG}.tar.gz > \
                  schiavinato-sharing-${TAG}.tar.gz.sha256
        
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-sharing-${TAG}.tar.gz
        
        gpg --verify schiavinato-sharing-${TAG}.tar.gz.asc \
                     schiavinato-sharing-${TAG}.tar.gz
        
        echo "✓ Release tarball created, checksummed, and signed"
        ls -lh schiavinato-sharing-*.tar.gz*
    
    # ============================================
    # 8. UPLOAD ARTIFACTS (dry-run)
    # ============================================
    - name: Upload artifacts (dry-run)
      uses: actions/upload-artifact@4c0ff1c489dca52fedb26375d7d8fe7bd9233f19 # v4.4.0
      with:
        name: release-dry-run-${{ steps.meta.outputs.tag_norm }}
        path: |
          CHECKSUMS-LIBRARY.txt
          CHECKSUMS-LIBRARY.txt.asc
          schiavinato-sharing-*.tar.gz
          schiavinato-sharing-*.tar.gz.sha256
          schiavinato-sharing-*.tar.gz.asc
          validator/CHECKSUMS-VALIDATOR.txt
          validator/CHECKSUMS-VALIDATOR.txt.asc
          validator/dist/schiavinato-validator-*.html
          validator/dist/schiavinato-validator-*.html.sha256
          validator/dist/schiavinato-validator-*.html.asc
          validator/dist/schiavinato-validator-*.html.sha256.asc
        retention-days: 14

  release:
    name: Release (publish library + upload assets)
    runs-on: ubuntu-latest
    environment: npm-publish
    permissions:
      contents: write
      id-token: write
    if: github.event_name == 'release'

    steps:
    - name: Checkout tagged code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
      with:
        node-version: '24.x'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Resolve version metadata (and verify tag matches)
      id: meta
      shell: bash
      run: |
        set -euo pipefail
        PKG_VERSION="$(node -p "require('./package.json').version")"
        TAG_FROM_EVENT="${{ github.event.release.tag_name }}"
        TAG_NORM="v${PKG_VERSION}"
        echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"
        echo "tag_norm=$TAG_NORM" >> "$GITHUB_OUTPUT"
        if [ "$TAG_FROM_EVENT" != "$TAG_NORM" ] && [ "$TAG_FROM_EVENT" != "$PKG_VERSION" ]; then
          echo "Tag/version mismatch: tag=$TAG_FROM_EVENT pkg=$PKG_VERSION (expected $TAG_NORM)" >&2
          exit 1
        fi

    - name: Run full test suite
      run: npm test

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Run linter
      run: npm run lint

    - name: Run type check
      run: npm run typecheck

    - name: Dependency audit (high/critical)
      run: npm audit --audit-level=high --omit=dev

    - name: Build main library
      run: npm run build

    - name: Build browser bundle
      run: npm run build:browser

    - name: Build validator
      run: npm run build:validator

    - name: Verify validator version matches
      run: cd validator && npm run verify

    - name: Import GPG key
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        gpg --list-secret-keys --keyid-format LONG

    - name: Generate checksums (main library)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd dist
        {
          echo "# SHA256 Checksums - @grifortis/schiavinato-sharing"
          echo ""
          echo "Version: ${TAG}"
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "## Main Package Files"
          echo ""
          sha256sum index.js index.mjs index.d.ts index.d.mts
          echo ""
          echo "## Browser Bundle"
          echo ""
        } > ../CHECKSUMS-LIBRARY.txt
        cd browser
        sha256sum index.global.js >> ../../CHECKSUMS-LIBRARY.txt
        cd ../..

    - name: Generate checksums (validator)
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        {
          echo "# SHA256 Checksums - @grifortis/schiavinato-validator"
          echo ""
          echo "Version: ${TAG}"
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "## Validator HTML"
          echo ""
          sha256sum schiavinato-validator-${TAG}.html
        } > ../CHECKSUMS-VALIDATOR.txt
        cd ../..

    - name: Sign library checksums
      run: |
        set -euo pipefail
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-LIBRARY.txt
        gpg --verify CHECKSUMS-LIBRARY.txt.asc CHECKSUMS-LIBRARY.txt

    - name: Sign validator artifacts
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        cd validator/dist
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-validator-${TAG}.html.sha256
        gpg --verify schiavinato-validator-${TAG}.html.asc schiavinato-validator-${TAG}.html
        gpg --verify schiavinato-validator-${TAG}.html.sha256.asc schiavinato-validator-${TAG}.html.sha256
        cd ../..

    - name: Sign validator checksums
      run: |
        set -euo pipefail
        cd validator
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign CHECKSUMS-VALIDATOR.txt
        gpg --verify CHECKSUMS-VALIDATOR.txt.asc CHECKSUMS-VALIDATOR.txt
        cd ..

    - name: Create release tarball
      run: |
        set -euo pipefail
        TAG="${{ steps.meta.outputs.tag_norm }}"
        tar -czf schiavinato-sharing-${TAG}.tar.gz \
          dist/ \
          CHECKSUMS-LIBRARY.txt \
          CHECKSUMS-LIBRARY.txt.asc \
          README.md \
          LICENSE \
          CHANGELOG.md \
          package.json
        sha256sum schiavinato-sharing-${TAG}.tar.gz > schiavinato-sharing-${TAG}.tar.gz.sha256
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes \
          --passphrase-fd 0 --pinentry-mode loopback \
          --armor --detach-sign schiavinato-sharing-${TAG}.tar.gz
        gpg --verify schiavinato-sharing-${TAG}.tar.gz.asc schiavinato-sharing-${TAG}.tar.gz

    - name: Pack NPM tarball (for verification)
      id: npm_pack
      shell: bash
      env:
        HUSKY: '0'
      run: |
        set -euo pipefail
        # `npm pack --json` can be polluted by lifecycle scripts (e.g. husky) writing to stdout.
        # Capture *all* output and extract the JSON array robustly.
        PACK_OUT="$(npm pack --json 2>&1)"
        echo "${PACK_OUT}" > npm-pack.raw.txt
        PACK_FILENAME="$(node - <<'NODE'
        const fs = require('fs');
        const raw = fs.readFileSync('npm-pack.raw.txt', 'utf8');
        const start = raw.indexOf('[');
        const end = raw.lastIndexOf(']');
        if (start === -1 || end === -1 || end < start) {
          throw new Error('Could not locate JSON array in npm pack output');
        }
        const json = raw.slice(start, end + 1);
        const arr = JSON.parse(json);
        if (!Array.isArray(arr) || !arr[0]) throw new Error('Unexpected npm pack JSON output');
        const { shasum, integrity, filename } = arr[0];
        if (!shasum || !integrity || !filename) throw new Error('npm pack JSON missing fields');
        fs.appendFileSync(process.env.GITHUB_OUTPUT, `shasum=${shasum}\n`);
        fs.appendFileSync(process.env.GITHUB_OUTPUT, `integrity=${integrity}\n`);
        fs.appendFileSync(process.env.GITHUB_OUTPUT, `filename=${filename}\n`);
        console.log(filename);
        NODE
        )"
        echo "Packed tarball: ${PACK_FILENAME}"

    - name: Check if NPM version already published
      id: npm_version
      shell: bash
      run: |
        set -euo pipefail
        PKG="@grifortis/schiavinato-sharing"
        VER="${{ steps.meta.outputs.pkg_version }}"
        echo "Checking NPM for existing version: ${PKG}@${VER}"
        # Golden-standard idempotency: if the version exists, verify the registry tarball matches
        # the tarball we would publish from this tag. If it doesn't match, FAIL loudly.
        PUBLISHED_JSON="$(npm view "${PKG}@${VER}" --json 2>/dev/null || true)"
        if [ -z "${PUBLISHED_JSON}" ]; then
          echo "already_published=false" >> "$GITHUB_OUTPUT"
          echo "Not found on NPM: ${PKG}@${VER}"
          exit 0
        fi

        export PUBLISHED_JSON
        export WANT_SHASUM="${{ steps.npm_pack.outputs.shasum }}"
        export WANT_INTEGRITY="${{ steps.npm_pack.outputs.integrity }}"
        node - <<'NODE'
        const publishedRaw = process.env.PUBLISHED_JSON;
        const wantShasum = process.env.WANT_SHASUM;
        const wantIntegrity = process.env.WANT_INTEGRITY;
        if (!wantShasum || !wantIntegrity) throw new Error('Missing expected tarball hashes from npm pack');

        let data = JSON.parse(publishedRaw);
        if (Array.isArray(data)) data = data[0];
        if (!data || typeof data !== 'object') throw new Error('Unexpected npm view JSON output');
        const dist = data.dist || {};
        const gotShasum = dist.shasum;
        const gotIntegrity = dist.integrity;
        if (!gotShasum || !gotIntegrity) {
          throw new Error('npm view output missing dist.shasum/dist.integrity (cannot verify)');
        }
        if (gotShasum !== wantShasum || gotIntegrity !== wantIntegrity) {
          console.error('NPM published tarball does NOT match the tarball produced from this tag.');
          console.error(`Expected shasum:    ${wantShasum}`);
          console.error(`Registry shasum:    ${gotShasum}`);
          console.error(`Expected integrity: ${wantIntegrity}`);
          console.error(`Registry integrity: ${gotIntegrity}`);
          process.exit(1);
        }
        console.log('NPM published tarball matches local npm pack output.');
        NODE

        echo "already_published=true" >> "$GITHUB_OUTPUT"
        echo "Already published on NPM and verified: ${PKG}@${VER}"

    - name: Publish main library to NPM
      if: steps.npm_version.outputs.already_published != 'true'
      shell: bash
      env:
        HUSKY: '0'
      run: |
        set -u
        set -o pipefail
        LOG="$(mktemp)"
        set +e
        npm publish --provenance --access public 2>&1 | tee "$LOG"
        STATUS="${PIPESTATUS[0]}"
        set -e
        if [ "$STATUS" -ne 0 ]; then
          # Idempotency: treat "already published" as success so reruns don't fail.
          if grep -Fq "You cannot publish over the previously published versions" "$LOG"; then
            echo "NPM reports this version is already published. Continuing."
            exit 0
          fi
          echo "npm publish failed (see log above)" >&2
          exit "$STATUS"
        fi

    - name: Upload signed artifacts to release
      uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
      with:
        files: |
          CHECKSUMS-LIBRARY.txt
          CHECKSUMS-LIBRARY.txt.asc
          schiavinato-sharing-*.tar.gz
          schiavinato-sharing-*.tar.gz.sha256
          schiavinato-sharing-*.tar.gz.asc
          validator/CHECKSUMS-VALIDATOR.txt
          validator/CHECKSUMS-VALIDATOR.txt.asc
          validator/dist/schiavinato-validator-*.html
          validator/dist/schiavinato-validator-*.html.sha256
          validator/dist/schiavinato-validator-*.html.asc
          validator/dist/schiavinato-validator-*.html.sha256.asc
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
