name: Deprecate validator on NPM

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you deprecating the NPM package? (audit trail)"
        required: true
        type: string

jobs:
  deprecate:
    name: Deprecate @grifortis/schiavinato-validator
    runs-on: ubuntu-latest
    environment: npm-publish
    permissions:
      contents: read

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "24.x"
          registry-url: "https://registry.npmjs.org"

      - name: Authenticate to NPM
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "Missing secret NPM_TOKEN. Configure it in the 'npm-publish' environment secrets." >&2
            exit 1
          fi
          npm whoami

      - name: Deprecate package versions (idempotent)
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          REASON: ${{ inputs.reason }}
        run: |
          set -euo pipefail
          PKG='@grifortis/schiavinato-validator'
          MSG="DEPRECATED: Do NOT install/use via NPM. Validator is distributed as signed HTML in GitHub Releases. Repo: https://github.com/GRIFORTIS/schiavinato-sharing-js/tree/main/validator (Reason: ${REASON})"

          echo "Fetching versions for ${PKG}..."
          VERSIONS_JSON="$(npm view "${PKG}" versions --json)"

          PKG="${PKG}" MSG="${MSG}" VERSIONS_JSON="${VERSIONS_JSON}" node - <<'NODE'
          const { execFileSync } = require('node:child_process');
          const versions = JSON.parse(process.env.VERSIONS_JSON);
          const pkg = process.env.PKG;
          const msg = process.env.MSG;
          if (!Array.isArray(versions) || versions.length === 0) {
            throw new Error('No versions found to deprecate');
          }
          for (const v of versions) {
            const spec = `${pkg}@${v}`;
            console.log(`Deprecating ${spec}...`);
            execFileSync('npm', ['deprecate', spec, msg], { stdio: 'inherit' });
          }
          console.log(`Done. Deprecated ${versions.length} version(s) of ${pkg}.`);
          NODE
